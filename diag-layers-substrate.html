<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RD Diagram 2 — Substrate & Lenses (Alive)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --text:#050505;
      --muted:#6a6a6a;
      --border:#e5e5e5;
      --border-strong:#cfcfcf;

      --mono:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans:"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      --ok:#00cc00;
      --amber:#ffb000;
      --bad:#cc0000;

      --shadow: 0 14px 40px rgba(0,0,0,0.06);
      --shadow2: 0 10px 26px rgba(0,0,0,0.08);
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    .wrap{ max-width:1280px; margin:0 auto; padding:48px 24px 72px; }

    h1{ margin:0 0 8px 0; font-size:32px; font-weight:600; letter-spacing:-0.02em; }
    .sub{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:18px;
    }

    .intro{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 16px;
      background:#fff;
      margin-bottom:18px;
      max-width: 980px;
      line-height: 1.55;
      font-size: 13px;
      color: var(--text);
    }
    .intro strong{ font-weight:800; }

    .row{ display:flex; gap:18px; align-items:flex-start; }

    .card{
      flex:1;
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      background:#fff;
      position: relative;
      overflow: hidden;
    }

    .panel{
      width: 360px;
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      background:#fff;
      position: sticky;
      top: 18px;
    }

    .kicker{
      font-family:var(--mono);
      color:var(--muted);
      font-size:11px;
      letter-spacing:0.10em;
      text-transform:uppercase;
      margin-bottom:10px;
    }

    .modebar{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }

    .btn{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      cursor:pointer;
      border-radius:10px;
      user-select:none;
    }
    .btn:hover{ border-color:#bdbdbd; }
    .btn.active{ border-color:#050505; background:#050505; color:#ffffff; }

    .lensbar{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 14px; }

    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
    }
    .pill:hover{ border-color:#bdbdbd; }
    .pill.active{
      border-color:#050505;
      background:#fff;
      box-shadow: var(--shadow2);
      transform: translateY(-1px);
    }

    .dot{ width:8px; height:8px; border-radius:50%; background: var(--ok); }

    .meta{
      border-top:1px solid var(--border);
      padding-top:12px;
      margin-top:12px;
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      line-height:1.55;
    }
    .meta b{ color:var(--text); font-weight:800; }

    .moduleTitle{ font-size:16px; font-weight:800; letter-spacing:-0.01em; margin:6px 0 8px; }
    .moduleText{ font-size:13px; line-height:1.55; color:var(--text); }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      font-family:var(--mono);
      font-size:11px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--muted);
      background:#fff;
    }
    .chip strong{ color:var(--text); font-weight:800; }

    .svg-wrap{ width:100%; overflow:auto; }
    svg{ display:block; width:100%; height:auto; min-width:1100px; }

    /* SVG state hooks */
    .fade{ opacity:0.20; transition: opacity 180ms ease; }
    .on{ opacity:1; transition: opacity 180ms ease; }
    .raise{ filter: drop-shadow(0px 10px 18px rgba(0,0,0,0.10)); }

    /* TRACE dash motion */
    .tracePulse{ stroke-dasharray: 10 8; animation: dash 1.2s linear infinite; }
    @keyframes dash{ to { stroke-dashoffset: -36; } }

    /* Lens heartbeat */
    @keyframes heartbeat{
      0%{ filter: drop-shadow(0px 10px 18px rgba(0,0,0,0.10)); transform: translateY(0px); }
      50%{ filter: drop-shadow(0px 16px 28px rgba(0,0,0,0.14)); transform: translateY(-1px); }
      100%{ filter: drop-shadow(0px 10px 18px rgba(0,0,0,0.10)); transform: translateY(0px); }
    }
    .beat{ animation: heartbeat 0.9s ease-in-out infinite; }

    /* Scan overlay on TRACE click */
    .scan{
      position:absolute; inset:0;
      pointer-events:none;
      background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0) 100%);
      transform: translateX(-120%);
      opacity:0;
    }
    .scan.run{
      opacity:1;
      animation: scanMove 650ms ease-out 1;
    }
    @keyframes scanMove{
      0%{ transform: translateX(-120%); opacity:0.0; }
      15%{ opacity:1; }
      100%{ transform: translateX(120%); opacity:0.0; }
    }

    /* Cursor spotlight */
    .spotlight{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity 220ms ease;
      background:
        radial-gradient(420px 280px at var(--mx, 50%) var(--my, 50%),
          rgba(0,0,0,0.065),
          rgba(0,0,0,0.028) 35%,
          rgba(0,0,0,0.0) 70%);
    }
    .card:hover .spotlight{ opacity:1; }

    /* Toast */
    .toast{
      position:absolute;
      right:16px; bottom:16px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      transform: translateY(6px);
      transition: opacity 180ms ease, transform 180ms ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; transform: translateY(0px); }

    /* Verify ticks */
    @keyframes popIn{
      0%{ opacity:0; transform: translateY(2px); }
      100%{ opacity:1; transform: translateY(0); }
    }
    .vtick{ opacity:0; }
    .vtick.show{ animation: popIn 180ms ease-out forwards; }

    /* Lens hover preview */
    .preview{
      opacity:0.55 !important;
      filter: drop-shadow(0px 10px 18px rgba(0,0,0,0.08));
    }

    /* Export arm glow */
    .armGlow{
      filter: none;
      transition: filter 240ms ease, transform 240ms ease;
    }
    .armGlow.on{
      filter: drop-shadow(0px 12px 22px rgba(0,0,0,0.14));
      transform: translateY(-1px);
    }

    @media (max-width: 980px){
      .row{ flex-direction:column; }
      .panel{ width:100%; position:relative; top:auto; }
      svg{ min-width: 980px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Reflective Diagnostics — Measurement Substrate & Analytic Lenses</h1>
    <div class="sub">SYSTEM MAP • PUBLIC SAFE (NO INTERNAL METRICS) • STATUS: ACTIVE DEV</div>

    <div class="intro">
      This view is a <strong>system map</strong>, not the dashboard UI.
      It shows the <strong>shared evidence substrate (L1)</strong> and the <strong>analytic regimes (L2–L7)</strong> that operate over the same records.
      Interactive modules, oracle assistance, and API surfaces exist downstream and are intentionally omitted here.
    </div>

    <div class="row">
      <div class="card" id="card">
        <div class="scan" id="scan"></div>
        <div class="spotlight" id="spotlight"></div>
        <div class="toast" id="toast">TRACE ACTIVE</div>

        <div class="svg-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" width="1400" height="520" viewBox="0 0 1400 520" role="img" aria-label="Measurement substrate and analytic lenses">
            <defs>
              <style>
                .frame{fill:#ffffff;stroke:#e5e5e5;stroke-width:1.5}
                .box{fill:#ffffff;stroke:#cfcfcf;stroke-width:1.5}
                .boxLite{fill:#ffffff;stroke:#e5e5e5;stroke-width:1.25}
                .mono{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;fill:#050505}
                .muted{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;fill:#6a6a6a}
                .h{font-size:13px;font-weight:700;letter-spacing:0.12em}
                .t{font-size:12px}
                .micro{font-size:11px;letter-spacing:0.06em}
                .link{stroke:#8a8a8a;stroke-width:2;fill:none}
                .badge{fill:#ffffff;stroke:#cfcfcf;stroke-width:1.25}
                .ok{fill:#00cc00}
              </style>
              <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="#8a8a8a"/>
              </marker>
              <marker id="arrowOn" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="#050505"/>
              </marker>
            </defs>

            <rect class="frame" x="40" y="40" width="1320" height="440" rx="18"/>

            <text class="mono" x="78" y="92" style="font-size:20px;font-weight:700;letter-spacing:-0.01em;">
              Shared Substrate → Multiple Lenses (Single Dashboard)
            </text>
            <text class="muted micro" x="78" y="116">BUILD v5 • 2026 • PUBLIC MAP (EVIDENCE CONTRACT SHOWN)</text>

            <text class="muted micro" x="78" y="138" id="telemetryLine">
              TELEMETRY: cycle 0215 • phase 02/06 • jitter 0.00
            </text>

            <g id="auditBadge">
              <rect class="badge" x="1065" y="74" width="250" height="34" rx="10"/>
              <circle class="ok" cx="1085" cy="91" r="5"/>
              <text class="mono micro" x="1098" y="95" style="font-weight:700;letter-spacing:0.10em;">AUDIT MODE ACTIVE</text>
            </g>

            <g id="L1" class="on">
              <rect class="box" x="78" y="160" width="420" height="250" rx="14"/>
              <text class="mono h" x="110" y="200">L1 — RECORD OBSERVATORY</text>
              <text class="muted t" x="110" y="232">immutable record boundary</text>
              <text class="muted t" x="110" y="254">provenance + content hashing</text>
              <text class="muted t" x="110" y="276">span indexing + evidence links</text>
              <text class="muted t" x="110" y="298">replay / longitudinal comparison</text>

              <rect class="boxLite" x="110" y="324" width="356" height="76" rx="12"/>
              <text class="mono micro" x="130" y="350" style="font-weight:700;">EVIDENCE CHAIN (INVARIANT)</text>
              <text class="muted micro" x="130" y="372">metric → span → source → hash</text>

              <g id="verifyTicks">
                <text class="mono micro vtick" id="vt1" x="130" y="392">✓</text>
                <text class="mono micro vtick" id="vt2" x="240" y="392">✓</text>
                <text class="mono micro vtick" id="vt3" x="350" y="392">✓</text>
                <text class="mono micro vtick" id="vt4" x="430" y="392">✓</text>
              </g>

              <rect class="badge" x="90" y="174" width="70" height="26" rx="8"/>
              <text class="mono" x="110" y="192" style="font-size:12px;font-weight:700;">LIVE</text>
            </g>

            <rect class="boxLite" x="540" y="160" width="780" height="250" rx="14"/>
            <text class="muted micro" x="564" y="190">ANALYTIC LENSES (L2–L7) • SAME RECORD SET • SWAPPABLE VIEW</text>

            <g id="L2" class="fade">
              <rect class="box" x="564" y="212" width="240" height="78" rx="12"/>
              <text class="mono h" x="586" y="242">L2 — REFLECTION</text>
              <text class="muted t" x="586" y="268">stability • deltas • signatures</text>
              <circle class="ok" cx="782" cy="232" r="5"/>
              <text class="muted micro" x="792" y="236">ACTIVE DEV</text>
            </g>

            <g id="L3" class="fade">
              <rect class="box" x="828" y="212" width="240" height="78" rx="12"/>
              <text class="mono h" x="850" y="242">L3 — REASONING</text>
              <text class="muted t" x="850" y="268">chains • closure • integrity</text>
              <circle class="ok" cx="1046" cy="232" r="5"/>
              <text class="muted micro" x="1056" y="236">ACTIVE DEV</text>
            </g>

            <g id="L4" class="fade">
              <rect class="box" x="1092" y="212" width="206" height="78" rx="12"/>
              <text class="mono h" x="1114" y="242">L4 — DRIFT</text>
              <text class="muted t" x="1114" y="268">onset • escalation • time</text>
              <circle class="ok" cx="1276" cy="232" r="5"/>
              <text class="muted micro" x="1286" y="236">ACTIVE DEV</text>
            </g>

            <g id="L5" class="fade">
              <rect class="box" x="564" y="308" width="240" height="78" rx="12"/>
              <text class="mono h" x="586" y="338">L5 — AGENCY</text>
              <text class="muted t" x="586" y="364">persistence • resistance • framing</text>
              <circle class="ok" cx="782" cy="328" r="5"/>
              <text class="muted micro" x="792" y="332">ACTIVE DEV</text>
            </g>

            <g id="L6" class="fade">
              <rect class="box" x="828" y="308" width="240" height="78" rx="12"/>
              <text class="mono h" x="850" y="338">L6 — INTERACTION</text>
              <text class="muted t" x="850" y="364">coupling • feedback sensitivity</text>
              <circle class="ok" cx="1046" cy="328" r="5"/>
              <text class="muted micro" x="1056" y="332">ACTIVE DEV</text>
            </g>

            <g id="L7" class="fade">
              <rect class="box" x="1092" y="308" width="206" height="78" rx="12"/>
              <text class="mono h" x="1114" y="338">L7 — EARTH</text>
              <text class="muted t" x="1114" y="364">context layer • coupling surface</text>
              <circle class="ok" cx="1276" cy="328" r="5"/>
              <text class="muted micro" x="1286" y="332">ACTIVE DEV</text>
            </g>

            <path id="linkSubToLenses" class="link fade" marker-end="url(#arrow)" d="M498 285 L540 285"/>

            <g id="traceOverlay" style="display:none;">
              <path class="link" marker-end="url(#arrowOn)" d="M180 260 L440 260" style="stroke:#050505;stroke-width:2.5"/>
              <path class="link" marker-end="url(#arrowOn)" d="M498 285 L540 285" style="stroke:#050505;stroke-width:2.5"/>
            </g>

            <g id="packetStrip">
              <rect class="boxLite" x="78" y="430" width="1242" height="42" rx="12"/>
              <text class="mono micro" x="98" y="456" style="font-weight:800;letter-spacing:0.10em;">AUDIT PACKET (REDACTED PREVIEW)</text>
              <text class="muted micro" x="400" y="456">record_id:</text>
              <text class="mono micro" x="478" y="456" style="font-weight:800;">RD-REC-0215-0A7C</text>
              <text class="muted micro" x="700" y="456">sha256:</text>
              <text class="mono micro" x="770" y="456" style="font-weight:800;">9f2c…b18e</text>

              <g id="exportGroup" class="armGlow">
                <rect class="badge" x="1060" y="440" width="112" height="24" rx="8"/>
                <text class="mono micro" x="1085" y="456" style="font-weight:800;">EXPORT</text>
              </g>

              <g id="viewGroup" class="armGlow">
                <rect class="badge" x="1182" y="440" width="112" height="24" rx="8"/>
                <text class="mono micro" x="1214" y="456" style="font-weight:800;">VIEW</text>
              </g>

              <text class="muted micro" x="980" y="456" id="ticker" style="display:none;">tick: 0007</text>
            </g>
          </svg>
        </div>
      </div>

      <div class="panel">
        <div class="kicker">controls</div>

        <div class="modebar">
          <button class="btn active" id="modeMap">MAP</button>
          <button class="btn" id="modeTrace">TRACE</button>
          <button class="btn" id="pulseBtn">PULSE</button>
        </div>

        <div class="kicker" style="margin-top:10px;">analytic regimes</div>
        <div class="lensbar" id="lensbar"></div>

        <div class="moduleTitle" id="moduleTitle">L2 — Reflection</div>
        <div class="moduleText" id="moduleText">
          Measures reflection impact as deltas between direct and reflective outputs, without re-judging truth, intent, or policy.
        </div>

        <div class="chips" id="chips">
          <div class="chip"><strong>STATUS</strong> ACTIVE DEV</div>
          <div class="chip"><strong>SCOPE</strong> evidence-only</div>
          <div class="chip"><strong>OUTPUT</strong> auditable</div>
        </div>

        <div class="meta">
          <div><b>Design signal:</b> one substrate, many lenses.</div>
          <div><b>Claim boundary:</b> structure-only, evidence-anchored.</div>
          <div><b>Update cost:</b> status text changes only (map stays valid).</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== DATA =====
    const MODULES = [
      { key:"L2", label:"L2", title:"L2 — Reflection",
        text:"Measures reflection impact as deltas between direct and reflective outputs, without re-judging truth, intent, or policy.",
        chips:["STATUS: ACTIVE DEV","SCOPE: deltas","EVIDENCE: spans"] },
      { key:"L3", label:"L3", title:"L3 — Reasoning",
        text:"Analyzes structural integrity of reasoning: dependency chains, closure, contradiction patterns, and unsupported transitions (structure-only).",
        chips:["STATUS: ACTIVE DEV","SCOPE: chains","EVIDENCE: spans"] },
      { key:"L4", label:"L4", title:"L4 — Drift",
        text:"Tracks longitudinal change across runs, time, or interactions: escalation, degradation, and onset trajectories as measurable structure.",
        chips:["STATUS: ACTIVE DEV","SCOPE: time-series","EVIDENCE: aggregates"] },
      { key:"L5", label:"L5", title:"L5 — Agency",
        text:"Detects persistence and resistance patterns without intent attribution: goal-like language signatures and correction response dynamics.",
        chips:["STATUS: ACTIVE DEV","SCOPE: persistence","EVIDENCE: spans"] },
      { key:"L6", label:"L6", title:"L6 — Interaction",
        text:"Measures coupling effects across multi-turn exchange: feedback sensitivity, interaction stability, and correction coupling over time.",
        chips:["STATUS: ACTIVE DEV","SCOPE: multi-turn","EVIDENCE: traces"] },
      { key:"L7", label:"L7", title:"L7 — Earth",
        text:"Context coupling surface: attaches structured world-state context alongside records (observational, audit-friendly, non-prescriptive).",
        chips:["STATUS: ACTIVE DEV","SCOPE: context","EVIDENCE: packets"] }
    ];

    // ===== STATE =====
    let active = "L2";
    let mode = "MAP";
    let pulsing = false;
    let pulseTimer = null;
    let tick = 7;

    // Telemetry state
    let phase = 2;
    let cycle = 215;
    let jitter = 0;

    // ===== DOM =====
    const lensbar = document.getElementById("lensbar");
    const moduleTitle = document.getElementById("moduleTitle");
    const moduleText = document.getElementById("moduleText");
    const chips = document.getElementById("chips");

    const modeMapBtn = document.getElementById("modeMap");
    const modeTraceBtn = document.getElementById("modeTrace");
    const pulseBtn = document.getElementById("pulseBtn");

    const card = document.getElementById("card");
    const spotlight = document.getElementById("spotlight");
    const scan = document.getElementById("scan");
    const toast = document.getElementById("toast");
    const telemetryLine = document.getElementById("telemetryLine");
    const ticker = document.getElementById("ticker");

    function el(id){ return document.getElementById(id); }

    // ===== UI HELPERS =====
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 950);
    }

    function runScan(){
      scan.classList.remove("run");
      void scan.offsetWidth;
      scan.classList.add("run");
    }

    function setBtnActive(btn, on){ btn.classList.toggle("active", !!on); }

    function renderChips(list){
      chips.innerHTML = "";
      list.forEach(s => {
        const d = document.createElement("div");
        d.className = "chip";
        const parts = s.split(":");
        if (parts.length >= 2){
          d.innerHTML = `<strong>${parts[0].trim()}</strong> ${parts.slice(1).join(":").trim()}`;
        } else {
          d.textContent = s;
        }
        chips.appendChild(d);
      });
    }

    // Export “arm” glow (SVG group)
    function armExport(){
      const g1 = el("exportGroup");
      const g2 = el("viewGroup");
      [g1,g2].forEach(g => {
        if(!g) return;
        g.classList.add("on");
        setTimeout(() => g.classList.remove("on"), 520);
      });
    }

    // ===== SPOTLIGHT TRACKING =====
    if(card && spotlight){
      card.addEventListener("mousemove", (e) => {
        const r = card.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        const y = ((e.clientY - r.top) / r.height) * 100;
        spotlight.style.setProperty("--mx", x + "%");
        spotlight.style.setProperty("--my", y + "%");
      });
    }

    // ===== TELEMETRY =====
    function setTelemetry(extra=""){
      if(!telemetryLine) return;
      telemetryLine.textContent =
        `TELEMETRY: cycle ${String(cycle).padStart(4,"0")} • phase ${String(phase).padStart(2,"0")}/06 • jitter ${jitter.toFixed(2)}${extra ? " • " + extra : ""}`;
    }

    function bumpTelemetry(tag){
      jitter = Math.max(0, Math.min(0.85, jitter + (Math.random()*0.18 - 0.06)));
      phase = Math.max(1, Math.min(6, phase + 1));
      if(phase === 6){ cycle += 1; phase = 1; }
      setTelemetry(tag);
    }

    // ===== VERIFY TICKS =====
    function clearVerify(){
      ["vt1","vt2","vt3","vt4"].forEach(id => {
        const t = el(id);
        if(!t) return;
        t.classList.remove("show");
        t.style.opacity = 0;
      });
    }

    function runVerify(){
      clearVerify();
      const ids = ["vt1","vt2","vt3","vt4"];
      ids.forEach((id, i) => {
        setTimeout(() => {
          const t = el(id);
          if(!t) return;
          t.classList.add("show");
          t.style.opacity = 1;
        }, 120 + i*140);
      });
    }

    // ===== MODES =====
    function setMode(next){
      mode = next;

      setBtnActive(modeMapBtn, mode === "MAP");
      setBtnActive(modeTraceBtn, mode === "TRACE");

      el("traceOverlay").style.display = (mode === "TRACE") ? "block" : "none";

      const link = el("linkSubToLenses");
      if(!link) return;

      if (mode === "TRACE") {
        link.classList.remove("fade");
        link.classList.add("on");
        link.style.stroke = "#050505";
        link.style.strokeWidth = "2.5";
        link.setAttribute("marker-end","url(#arrowOn)");
        link.classList.add("tracePulse");

        runScan();
        runVerify();
        bumpTelemetry("trace");
        showToast("TRACE ACTIVE");
      } else {
        link.style.stroke = "#8a8a8a";
        link.style.strokeWidth = "2";
        link.setAttribute("marker-end","url(#arrow)");
        link.classList.remove("tracePulse");
        link.classList.add("fade");
        link.classList.remove("on");

        clearVerify();
        bumpTelemetry("map");
        showToast("MAP ACTIVE");
      }

      armExport();
    }

    // ===== LENS ACTIVATION =====
    function clearLensBeat(){
      ["L2","L3","L4","L5","L6","L7"].forEach(k => el(k)?.classList.remove("beat"));
    }

    function activateLens(key){
      active = key;

      ["L2","L3","L4","L5","L6","L7"].forEach(k => {
        const g = el(k);
        if(!g) return;
        g.classList.add("fade");
        g.classList.remove("on");
        g.classList.remove("raise");
        g.classList.remove("preview");
      });

      const g = el(key);
      if(g){
        g.classList.remove("fade");
        g.classList.add("on");
        g.classList.add("raise");
        if(pulsing) g.classList.add("beat");
      }

      const m = MODULES.find(x => x.key === key);
      if(m){
        moduleTitle.textContent = m.title;
        moduleText.textContent = m.text;
        renderChips(m.chips);
      }

      bumpTelemetry(key.toLowerCase());
      armExport();
    }

    // ===== PULSE =====
    function startPulse(){
      if (pulseTimer) return;
      pulsing = true;
      pulseBtn.classList.add("active");
      ticker.style.display = "block";
      showToast("PULSE RUNNING");
      bumpTelemetry("pulse");

      clearLensBeat();
      el(active)?.classList.add("beat");

      const order = ["L2","L3","L4","L5","L6","L7"];
      let i = order.indexOf(active);
      if(i < 0) i = 0;

      pulseTimer = setInterval(() => {
        const key = order[i % order.length];
        activateLens(key);

        const pills = Array.from(document.querySelectorAll(".pill"));
        pills.forEach(x => x.classList.remove("active"));
        pills[i % pills.length]?.classList.add("active");

        tick++;
        ticker.textContent = `tick: ${String(tick).padStart(4,"0")}`;

        // If TRACE mode is on, keep verify feeling “alive”
        if(mode === "TRACE") runVerify();

        i++;
      }, 1200);
    }

    function stopPulse(){
      pulsing = false;
      pulseBtn.classList.remove("active");
      showToast("PULSE STOPPED");
      bumpTelemetry("pause");

      clearLensBeat();
      ticker.style.display = "none";

      if (pulseTimer){
        clearInterval(pulseTimer);
        pulseTimer = null;
      }
    }

    // ===== BUILD LENS PILLS + HOVER PREVIEW =====
    MODULES.forEach((m, idx) => {
      const p = document.createElement("div");
      p.className = "pill";
      p.innerHTML = `<span class="dot"></span><span>${m.label}</span>`;

      p.addEventListener("click", () => {
        document.querySelectorAll(".pill").forEach(x => x.classList.remove("active"));
        p.classList.add("active");
        activateLens(m.key);
      });

      p.addEventListener("mouseenter", () => {
        if(pulsing) return;
        if(m.key === active) return;
        el(m.key)?.classList.add("preview");
      });

      p.addEventListener("mouseleave", () => {
        el(m.key)?.classList.remove("preview");
      });

      lensbar.appendChild(p);
    });

    // ===== BUTTONS =====
    modeMapBtn.addEventListener("click", () => setMode("MAP"));
    modeTraceBtn.addEventListener("click", () => setMode("TRACE"));
    pulseBtn.addEventListener("click", () => pulsing ? stopPulse() : startPulse());

    // ===== INIT =====
    document.querySelectorAll(".pill")[0].classList.add("active");
    setTelemetry();
    activateLens("L2");
    setMode("MAP");
  </script>
</body>
</html>
