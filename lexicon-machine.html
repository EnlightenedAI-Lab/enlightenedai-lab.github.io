<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lexicon — Machine</title>

  <style>
    body { margin:0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    a { color:#5a2ca0; }
    .hidden { display:none !important; }
    .machine-overlay{
      position:fixed; inset:0; background:#fff; color:#111; z-index:9998;
      display:flex; flex-direction:column;
    }
    .mo-header{
      display:flex; flex-direction:column; gap:8px;
      border-bottom:1px solid #eee; padding:12px 16px;
    }
    .mo-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .mo-mode-toggle button{ margin-left:8px; }
    .mo-controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .mo-content{ flex:1; overflow:auto; padding:16px; }
    .mo-sub-nav{ display:flex; align-items:center; gap:10px; padding:8px 16px; border-bottom:1px solid #eee; }
    .mo-tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .code-container{ white-space:pre; border:1px solid #eee; padding:12px; border-radius:8px; overflow:auto; }
    .hex-footer{ display:none; border-top:1px solid #eee; padding:10px 16px; justify-content:space-between; align-items:center; gap:12px; }
    .active{ font-weight:700; }
    #operator-manual{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:9999; }
    #operator-manual.open{ display:block; }
    .manual-content{ background:#fff; margin:5vh auto; width:min(900px,92vw); height:90vh; overflow:auto; padding:18px; border-radius:12px; }
    .hud-close{ float:right; }
  </style>
</head>

<body data-mode="reader" data-theme="light">
  <script>
    if (window.innerWidth > 900) document.body.style.display = 'flex';
  </script>

  <a href="lexicon.html" style="position:fixed;top:12px;left:12px;font-size:12px;z-index:9999;">
    ← BACK TO LEXICON
  </a>

  <div id="machineOverlay" class="machine-overlay hidden">
    <div class="mo-header">
      <div class="mo-title">
        <div>
          MACHINE VIEW <span class="machine-led"></span>
          <span class="mo-mode-toggle">
            <button type="button" onclick="switchMachineMode('cards')" id="btn-mode-cards">[ CARDS ]</button>
            <button type="button" onclick="switchMachineMode('serialization')" id="btn-mode-serial">[ SERIALIZATION ]</button>
          </span>
        </div>
      </div>

      <div class="mo-controls">
        <span id="event-text">READY</span>
        <span id="sys-uptime">T+ 00:00:00</span>
        <button type="button" onclick="exportRecord()">EXPORT FILE</button>
        <button type="button" onclick="closeMachineOverlay()">CLOSE ✕</button>
      </div>
    </div>

    <div id="sub-nav" class="mo-sub-nav hidden">
      <button onclick="switchSerialMode('snapshot')" id="sn-snapshot" class="active">SNAPSHOT</button>
      <button onclick="switchSerialMode('transformation')" id="sn-transformation">TRANSFORMATION</button>
      <button onclick="switchSerialMode('diff')" id="sn-diff">DIFF</button>
      <span id="process-hash" style="margin-left:auto;">RECORD_HASH: 0x4F9A2B</span>
    </div>

    <div class="mo-content">
      <div id="machineCards" class="hidden"></div>

      <div id="view-snapshot" class="hidden">
        <div class="mo-tabs">
          <button onclick="renderFormat('json')" id="tab-json" class="active">JSON</button>
          <button onclick="renderFormat('yaml')" id="tab-yaml">YAML</button>
          <button onclick="renderFormat('md')" id="tab-md">MARKDOWN</button>
        </div>
        <div class="code-container" id="code-display"></div>
      </div>

      <div id="view-transformation" class="hidden">
        <div class="code-container" id="step-output"></div>
      </div>

      <div id="view-diff" class="hidden">
        <div class="code-container" id="diff-out"></div>
      </div>
    </div>

    <div class="hex-footer">
      <a href="#" onclick="toggleManual(true);return false;">[ OPERATOR MANUAL ]</a>
      <div id="hex-stream">MEM: 0x0000 | NULL</div>
      <div>SECURE LINK</div>
    </div>
  </div>

  <div id="operator-manual">
    <div class="manual-content">
      <button class="hud-close" onclick="toggleManual(false)">CLOSE</button>
      <h3>OPERATOR MANUAL</h3>
      <p>This is a deterministic UI demo. No model runs. No data leaves the browser.</p>
    </div>
  </div>

  <script>
    const LEXICON_RECORD = {
      meta: { doc_id: "RAL-LEX-0002", version: "33.0.0", classification: "PUBLIC", status: "ACTIVE" },
      core_terms: [
        { id: "RA-001", label: "Reflective Alignment", definition: "Capacity to preserve goal coherence." },
        { id: "RS-001", label: "Reasoning Stability", definition: "Resistance to degradation under pressure." },
        { id: "DRIFT",  label: "Drift", definition: "Measurable deviation without prompting." }
      ],
      invariants: [
        { id: "INV-001", name: "Goal Preservation", status: "ENFORCED" },
        { id: "INV-002", name: "Definition Consistency", status: "ENFORCED" },
        { id: "INV-005", name: "Non-Contradiction", status: "ENFORCED" }
      ]
    };

    let machineMode = "cards";
    let serialMode = "snapshot";
    let currentFormat = "json";

    function toggleManual(show){ document.getElementById("operator-manual").classList.toggle("open", !!show); }

    function openMachineOverlay(){
      const ov = document.getElementById("machineOverlay");
      if (!ov) return;
      ov.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      machineMode = localStorage.getItem("lex_machine_mode") || "cards";
      switchMachineMode(machineMode);
    }

    function closeMachineOverlay(){
      const ov = document.getElementById("machineOverlay");
      if (!ov) return;
      ov.classList.add("hidden");
      localStorage.setItem("lex_machine_dismissed", "1");
      document.body.style.overflow = "";
    }

    function switchMachineMode(mode){
      machineMode = mode;
      localStorage.setItem("lex_machine_mode", mode);

      const btnCards = document.getElementById("btn-mode-cards");
      const btnSer   = document.getElementById("btn-mode-serial");
      if (btnCards) btnCards.classList.toggle("active", mode === "cards");
      if (btnSer)   btnSer.classList.toggle("active", mode === "serialization");

      const sub = document.getElementById("sub-nav");
      sub.classList.toggle("hidden", mode !== "serialization");

      document.getElementById("machineCards").classList.toggle("hidden", mode !== "cards");
      document.getElementById("view-snapshot").classList.add("hidden");
      document.getElementById("view-transformation").classList.add("hidden");
      document.getElementById("view-diff").classList.add("hidden");

      if (mode === "cards"){
        renderCards();
        document.getElementById("machineCards").classList.remove("hidden");
      } else {
        switchSerialMode(serialMode);
      }
    }

    function switchSerialMode(mode){
      serialMode = mode;

      ["snapshot","transformation","diff"].forEach(m=>{
        document.getElementById(`sn-${m}`).classList.toggle("active", m===mode);
        document.getElementById(`view-${m}`).classList.toggle("hidden", m!==mode);
      });

      if (mode === "snapshot") renderFormat(currentFormat);
      if (mode === "transformation") document.getElementById("step-output").textContent =
        "RAW → PARSE → BIND → CONSTRAIN → SERIALIZE (demo)";
      if (mode === "diff") document.getElementById("diff-out").textContent =
        "narrative → constraint (demo)";
    }

    function renderFormat(fmt){
      currentFormat = fmt;
      ["json","yaml","md"].forEach(f=> document.getElementById(`tab-${f}`).classList.toggle("active", f===fmt));

      let out = "";
      if (fmt === "json") out = JSON.stringify(LEXICON_RECORD, null, 2);
      if (fmt === "yaml") out = `meta:\n  doc_id: ${LEXICON_RECORD.meta.doc_id}\n  version: ${LEXICON_RECORD.meta.version}\n`;
      if (fmt === "md")   out = `# ${LEXICON_RECORD.meta.doc_id}\n\n- Version: ${LEXICON_RECORD.meta.version}\n`;
      document.getElementById("code-display").textContent = out;
    }

    function renderCards(){
      const el = document.getElementById("machineCards");
      el.innerHTML =
        `<pre>${JSON.stringify(LEXICON_RECORD, null, 2)}</pre>`;
    }

    function exportRecord(){
      const content = JSON.stringify(LEXICON_RECORD, null, 2);
      const blob = new Blob([content], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "lexicon_record.txt"; a.click();
      URL.revokeObjectURL(url);
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      // open by default (no blank page)
      localStorage.removeItem("lex_machine_dismissed");
      openMachineOverlay();
    });

    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeMachineOverlay(); });
  </script>
</body>
</html>
