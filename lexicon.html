<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lexicon — Machine</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --font-stack:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --font-mono:"JetBrains Mono",ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --signal-red:#cc0000;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font-stack);background:#fff;color:#000}

    /* back link */
    .back{
      position:fixed;top:12px;left:12px;z-index:30000;
      font-family:var(--font-mono);font-size:12px;text-decoration:none;color:#666;
    }
    .back:hover{color:#000;text-decoration:underline}

    /* MACHINE OVERLAY */
    .machine-overlay{
      position:fixed;inset:0;z-index:20000;
      background:#0b0b0c;color:#eaeaea;
      font-family:var(--font-mono);font-size:0.75rem;
      display:flex;flex-direction:column;
    }
    .machine-overlay.hidden{display:none}

    .mo-header{
      padding:1rem 2rem;
      border-bottom:1px solid rgba(255,255,255,0.15);
      display:flex;justify-content:space-between;align-items:center;
      background:#0b0b0c;
      gap:1rem;
    }
    .mo-title{
      font-weight:700;letter-spacing:0.05em;color:#fff;
      display:flex;align-items:center;gap:1rem;flex-wrap:wrap;
    }
    .mo-mode-toggle{display:flex;gap:6px}
    .mo-mode-btn{
      background:transparent;border:none;color:#888;
      font-family:inherit;font-size:0.7rem;font-weight:600;cursor:pointer;
      padding:2px 4px;
    }
    .mo-mode-btn.active{color:#fff;text-decoration:underline;text-underline-offset:4px}
    .mo-mode-btn:hover{color:#ccc}

    .mo-controls{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }
    .event-ticker{display:flex;align-items:center;gap:8px;color:#aaa;font-size:0.65rem}
    .event-dot{width:6px;height:6px;border-radius:50%;background:#00cc00;display:inline-block}
    .uptime{color:#888;font-size:0.65rem}
    .mo-controls button{
      background:transparent;border:1px solid #444;color:#999;
      padding:4px 12px;cursor:pointer;font-family:inherit;font-size:0.65rem;
      transition:all .15s;
    }
    .mo-controls button:hover{border-color:#fff;color:#fff}

    .mo-tabs{
      padding:0 2rem;border-bottom:1px solid rgba(255,255,255,0.15);
      background:#111;display:flex;gap:1px;flex-wrap:wrap;
    }
    .mo-tabs.hidden{display:none}
    .mo-tab{
      background:transparent;border:none;color:#666;
      padding:10px 16px;cursor:pointer;font-family:inherit;font-size:0.7rem;font-weight:600;
      border-bottom:2px solid transparent;
    }
    .mo-tab:hover{color:#ccc}
    .mo-tab.active{color:#fff;border-bottom-color:#fff;background:#1a1a1a}

    .mo-content{flex:1;padding:2rem;overflow:auto;background:#0e0e0e}
    .card-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;max-width:1200px;margin:0 auto}
    .m-card{background:#1a1a1a;border:1px solid #333;padding:1.25rem}
    .mc-header{
      color:#666;font-size:0.65rem;font-weight:700;
      border-bottom:1px solid #333;padding-bottom:0.5rem;margin-bottom:0.75rem;
      display:flex;justify-content:space-between;gap:1rem
    }
    .mc-row{margin-bottom:0.5rem;display:grid;grid-template-columns:110px 1fr;gap:1rem}
    .mc-label{color:#666;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.05em}
    .mc-val{color:#eee;font-size:0.75rem}
    .mc-section-title{
      grid-column:span 2;color:#999;font-size:0.7rem;font-weight:700;
      margin:2rem 0 1rem 0;letter-spacing:0.05em;
      border-left:2px solid #444;padding-left:10px
    }
    pre{
      margin:0;white-space:pre-wrap;word-break:break-word;color:#ccc;line-height:1.6;
      max-width:1200px;margin-inline:auto
    }

    @media (max-width:900px){
      .mo-header{padding:1rem;flex-direction:column;align-items:flex-start}
      .mo-content{padding:1rem}
      .card-grid{grid-template-columns:1fr}
      .mc-section-title{grid-column:span 1}
    }
  </style>
</head>

<body>
  <a class="back" href="lexicon.html">← BACK TO LEXICON</a>

  <div id="machineOverlay" class="machine-overlay">
    <div class="mo-header">
      <div class="mo-title">
        MACHINE VIEW
        <div class="mo-mode-toggle">
          <button type="button" onclick="switchMachineMode('cards')" class="mo-mode-btn" id="btn-mode-cards">[ CARDS ]</button>
          <button type="button" onclick="switchMachineMode('serialization')" class="mo-mode-btn" id="btn-mode-serial">[ SERIALIZATION ]</button>
        </div>
      </div>

      <div class="mo-controls">
        <span class="event-ticker"><span class="event-dot"></span><span id="event-text">READY</span></span>
        <span class="uptime" id="sys-uptime">T+ 00:00:00</span>
        <button type="button" onclick="exportRecord()">EXPORT FILE</button>
        <button type="button" onclick="closeMachineOverlay()">CLOSE ✕</button>
      </div>
    </div>

    <div id="moTabs" class="mo-tabs">
      <button class="mo-tab active" id="tab-json" onclick="renderFormat('json')">JSON</button>
      <button class="mo-tab" id="tab-yaml" onclick="renderFormat('yaml')">YAML</button>
      <button class="mo-tab" id="tab-python" onclick="renderFormat('python')">PYTHON</button>
      <button class="mo-tab" id="tab-ts" onclick="renderFormat('ts')">TYPESCRIPT</button>
      <button class="mo-tab" id="tab-sql" onclick="renderFormat('sql')">SQL</button>
      <button class="mo-tab" id="tab-md" onclick="renderFormat('md')">MARKDOWN</button>
    </div>

    <div class="mo-content">
      <div id="machineCards" class="card-grid"></div>
      <pre id="machineCode" style="display:none;"></pre>
    </div>
  </div>

  <script>
    const LEXICON_RECORD = {
      meta: { doc_id: "RAL-LEX-0002", version: "17.0.0", classification: "PUBLIC", status: "ACTIVE", last_update: new Date().toISOString().split('T')[0] },
      core_terms: [
        { id: "RA-001", label: "Reflective Alignment", type: "Global Property", definition: "Capacity to preserve goal coherence during recursive self-modification." },
        { id: "RS-001", label: "Reasoning Stability", type: "Local Property", definition: "Resistance of internal reasoning chains to degradation under scale pressure." },
        { id: "DRIFT", label: "Drift", type: "Measurement", definition: "Measurable deviation from invariant constraints without external prompting." }
      ],
      invariants: [
        { id: "INV-001", name: "Goal Preservation", scope: "Global", status: "ENFORCED" },
        { id: "INV-002", name: "Definition Consistency", scope: "Global", status: "ENFORCED" },
        { id: "INV-005", name: "Non-Contradiction", scope: "Global", status: "ENFORCED" }
      ],
      failure_signatures: [
        { signature: "OBJ_MUTATION", condition: "Objective divergence", severity: "CRITICAL" },
        { signature: "SEMANTIC_DRIFT", condition: "Term meaning deviation", severity: "HIGH" },
        { signature: "LOGIC_NEGATION", condition: "Internal contradiction", severity: "CRITICAL" }
      ]
    };

    let currentFormat = "json";
    let machineMode = localStorage.getItem("lex_machine_mode") || "cards";

    function closeMachineOverlay(){
      // keep simple: go back
      window.location.href = "lexicon.html";
    }

    function switchMachineMode(mode){
      machineMode = mode;
      localStorage.setItem("lex_machine_mode", mode);

      document.getElementById("btn-mode-cards").classList.toggle("active", mode === "cards");
      document.getElementById("btn-mode-serial").classList.toggle("active", mode === "serialization");

      document.getElementById("moTabs").classList.toggle("hidden", mode !== "serialization");
      document.getElementById("machineCards").style.display = (mode === "cards") ? "grid" : "none";
      document.getElementById("machineCode").style.display  = (mode === "serialization") ? "block" : "none";

      if(mode === "cards") renderCards();
      else renderFormat(currentFormat);
    }

    function renderCards(){
      const c = document.getElementById("machineCards");
      let html = "";

      html += `
        <div class="m-card">
          <div class="mc-header"><div>METADATA</div><div>${LEXICON_RECORD.meta.status}</div></div>
          <div class="mc-row"><div class="mc-label">DOC_ID</div><div class="mc-val">${LEXICON_RECORD.meta.doc_id}</div></div>
          <div class="mc-row"><div class="mc-label">VERSION</div><div class="mc-val">${LEXICON_RECORD.meta.version}</div></div>
          <div class="mc-row"><div class="mc-label">CLASS</div><div class="mc-val">${LEXICON_RECORD.meta.classification}</div></div>
          <div class="mc-row"><div class="mc-label">UPDATED</div><div class="mc-val">${LEXICON_RECORD.meta.last_update}</div></div>
        </div>
      `;

      html += `<div class="mc-section-title">CORE TERMS</div>`;
      LEXICON_RECORD.core_terms.forEach(t=>{
        html += `
          <div class="m-card">
            <div class="mc-header"><div>${t.id}</div><div>${t.type}</div></div>
            <div class="mc-row"><div class="mc-label">LABEL</div><div class="mc-val">${t.label}</div></div>
            <div class="mc-row"><div class="mc-label">DEF</div><div class="mc-val">${t.definition}</div></div>
          </div>
        `;
      });

      html += `<div class="mc-section-title">INVARIANTS</div>`;
      LEXICON_RECORD.invariants.forEach(i=>{
        html += `
          <div class="m-card">
            <div class="mc-header"><div>${i.id}</div><div>${i.status}</div></div>
            <div class="mc-row"><div class="mc-label">NAME</div><div class="mc-val">${i.name}</div></div>
            <div class="mc-row"><div class="mc-label">SCOPE</div><div class="mc-val">${i.scope}</div></div>
          </div>
        `;
      });

      html += `<div class="mc-section-title">FAILURE SIGNATURES</div>`;
      LEXICON_RECORD.failure_signatures.forEach(f=>{
        html += `
          <div class="m-card">
            <div class="mc-header"><div>${f.signature}</div><div style="color:var(--signal-red)">${f.severity}</div></div>
            <div class="mc-row"><div class="mc-label">TRIGGER</div><div class="mc-val">${f.condition}</div></div>
          </div>
        `;
      });

      c.innerHTML = html;
    }

    function renderFormat(fmt){
      currentFormat = fmt;

      document.querySelectorAll(".mo-tab").forEach(t=>t.classList.remove("active"));
      const active = document.getElementById(`tab-${fmt}`);
      if(active) active.classList.add("active");

      const codeEl = document.getElementById("machineCode");
      let out = "";

      if(fmt === "json"){
        out = JSON.stringify(LEXICON_RECORD, null, 2);
      } else if(fmt === "yaml"){
        out = `meta:\n  doc_id: ${LEXICON_RECORD.meta.doc_id}\n  version: ${LEXICON_RECORD.meta.version}\n  classification: ${LEXICON_RECORD.meta.classification}\n  status: ${LEXICON_RECORD.meta.status}\n\ncore_terms:\n` +
          LEXICON_RECORD.core_terms.map(t=>`  - id: ${t.id}\n    label: ${t.label}\n    type: ${t.type}\n    definition: ${t.definition}\n`).join("") +
          `\ninvariants:\n` +
          LEXICON_RECORD.invariants.map(i=>`  - id: ${i.id}\n    name: ${i.name}\n    scope: ${i.scope}\n    status: ${i.status}\n`).join("");
      } else if(fmt === "python"){
        out = "LEXICON_RECORD = " + JSON.stringify(LEXICON_RECORD, null, 2);
      } else if(fmt === "ts"){
        out = "export const LEXICON_RECORD = " + JSON.stringify(LEXICON_RECORD, null, 2) + " as const;";
      } else if(fmt === "sql"){
        out =
`-- minimal schema example
CREATE TABLE lexicon_meta (doc_id TEXT PRIMARY KEY, version TEXT, classification TEXT, status TEXT, last_update TEXT);
CREATE TABLE lexicon_terms (id TEXT PRIMARY KEY, label TEXT, type TEXT, definition TEXT);
CREATE TABLE lexicon_invariants (id TEXT PRIMARY KEY, name TEXT, scope TEXT, status TEXT);
CREATE TABLE lexicon_failures (signature TEXT PRIMARY KEY, condition TEXT, severity TEXT);`;
      } else if(fmt === "md"){
        out =
`# Lexicon Record: ${LEXICON_RECORD.meta.doc_id}

- Version: ${LEXICON_RECORD.meta.version}
- Classification: ${LEXICON_RECORD.meta.classification}
- Status: ${LEXICON_RECORD.meta.status}

## Core Terms
${LEXICON_RECORD.core_terms.map(t=>`- **${t.id}** (${t.type}): ${t.label} — ${t.definition}`).join("\n")}

## Invariants
${LEXICON_RECORD.invariants.map(i=>`- **${i.id}** (${i.status}): ${i.name} [${i.scope}]`).join("\n")}

## Failure Signatures
${LEXICON_RECORD.failure_signatures.map(f=>`- **${f.signature}** (${f.severity}): ${f.condition}`).join("\n")}`;
      }

      codeEl.textContent = out;
    }

    function exportRecord(){
      const content = (machineMode === "cards")
        ? JSON.stringify(LEXICON_RECORD, null, 2)
        : document.getElementById("machineCode").textContent;

      const ext =
        currentFormat === "ts" ? "ts" :
        currentFormat === "python" ? "py" :
        currentFormat;

      const blob = new Blob([content], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `lexicon_record.${ext}`;
      a.click();
      URL.revokeObjectURL(url);

      const t = document.getElementById("event-text");
      if(t) t.textContent = "EVENT: export(record) → COMPLETE";
    }

    // uptime
    const start = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-start)/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,"0");
      const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      document.getElementById("sys-uptime").textContent = `T+ ${hh}:${mm}:${ss}`;
    }, 500);

    // init
    switchMachineMode(machineMode);
  </script>
</body>
</html>
