<!-- SAVE AS: /docs/diag-diagram-preview.html  -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deterministic Workflow</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --text:#050505;
      --muted:#6a6a6a;
      --border:#e5e5e5;
      --border2:#cfcfcf;

      --mono:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans:"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      --ok:#00cc00;

      --inactiveOpacity:0.22;
      --activeOpacity:1;

      /* Selection (NOT success) */
      --activeStroke:#050505;
      --activeStrokeW:2.5;

      --arrowOn:#050505;
      --arrowOff:#8a8a8a;

      --radius:18px;
    }

    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    .wrap{ max-width:1240px; margin:0 auto; padding:42px 24px 60px; }

    /* Page title: shorter */
    h1{
      margin:0 0 6px 0;
      font-size:34px;
      font-weight:650;
      letter-spacing:-0.02em;
    }
    .sub{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    .row{
      display:flex;
      align-items:flex-start;
      gap:18px;
      margin-top:18px;
    }

    .card{
      flex: 1;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      background:var(--bg);
    }

    /* Panel: more readable */
    .panel{
      width: 420px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px 16px 14px;
      background:var(--bg);
      position: sticky;
      top: 16px;
    }

    .panel .kicker{
      font-family:var(--mono);
      color:var(--muted);
      font-size:11px;
      letter-spacing:0.10em;
      text-transform:uppercase;
      margin-bottom:10px;
    }

    .stepnum{
      font-family:var(--mono);
      font-size:13px;
      letter-spacing:0.10em;
      color:var(--muted);
      margin-bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .stepnum .smallHint{
      font-size:11px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--muted);
      opacity:0.85;
      white-space:nowrap;
    }

    .steptitle{
      font-size:18px;
      font-weight:800;
      letter-spacing:-0.01em;
      margin:0 0 10px 0;
      line-height:1.15;
    }

    .steptext{
      font-family:var(--sans);
      font-size:14px;
      color:var(--text);
      line-height:1.6;
      margin-bottom:12px;
    }

    /* Progress: bigger, numbered, clickable */
    .progress{
      display:flex;
      gap:10px;
      margin:12px 0 12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tick{
      display:flex;
      align-items:center;
      justify-content:center;
      width:46px;
      height:28px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-family:var(--mono);
      font-size:12px;
      font-weight:700;
      color:#777;
      transition: border-color 140ms ease, background 140ms ease, color 140ms ease, transform 140ms ease;
    }
    .tick:hover{ border-color:#bdbdbd; transform: translateY(-1px); }
    .tick.on{
      border-color:#d2d2d2;
      background:#f5f5f5;
      color:#6a6a6a;
    }
    .tick.active{
      border-color:#050505;
      background:#050505;
      color:#fff;
      transform:none;
    }

    /* Optional: mini list for clarity */
    .stepList{
      border-top:1px solid var(--border);
      padding-top:12px;
      margin-top:10px;
    }
    .stepRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 10px;
      border:1px solid transparent;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      transition: background 140ms ease, border-color 140ms ease;
    }
    .stepRow:hover{ background:#fafafa; border-color:#ededed; }
    .stepRow.active{ background:#f7f7f7; border-color:#e6e6e6; }
    .stepRow .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .stepRow .n{
      width:26px; height:26px;
      border:1px solid var(--border2);
      border-radius:9px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:var(--mono);
      font-size:12px;
      font-weight:800;
      color:#050505;
      flex:0 0 auto;
      background:#fff;
    }
    .stepRow.active .n{
      border-color:#050505;
      background:#050505;
      color:#fff;
    }
    .stepRow .label{
      font-size:13px;
      font-weight:700;
      color:#222;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stepRow .chev{
      font-family:var(--mono);
      font-size:12px;
      color:#8a8a8a;
      flex:0 0 auto;
    }

    .controls{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }

    .btn{
      font-family:var(--mono);
      font-size:12px;
      padding:9px 11px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      cursor:pointer;
      border-radius:10px;
      user-select:none;
    }
    .btn:hover{ border-color: #bdbdbd; }

    .svg-wrap{ width:100%; overflow:auto; }
    svg{ display:block; width:100%; height:auto; min-width:1200px; }

    /* Guided emphasis */
    .dim { opacity: var(--inactiveOpacity); transition: opacity 180ms ease; }
    .active { opacity: var(--activeOpacity); transition: opacity 180ms ease; }

    .badge { display:none; }
    .badge.show { display:block; }

    /* subtle lift for active element */
    .lift{
      filter: drop-shadow(0 12px 18px rgba(0,0,0,0.16)) drop-shadow(0 2px 0 rgba(0,0,0,0.05));
      transform: translateY(-1px);
      transform-origin: center;
    }

    @media (max-width: 980px){
      .row{ flex-direction:column; }
      .panel{ width:100%; position:relative; top:auto; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Deterministic Workflow</h1>
    <div class="sub">GUIDED SEQUENCE • PUBLIC SAFE (NO INTERNAL METRICS)</div>

    <div class="row">
      <div class="card">
        <div class="svg-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="720" viewBox="0 0 1600 720" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Deterministic workflow">
            <defs>
              <style>
                .frame{fill:#ffffff;stroke:#e5e5e5;stroke-width:1.5}
                .box{fill:#ffffff;stroke:#cfcfcf;stroke-width:1.5}
                .boxSoft{fill:#ffffff;stroke:#e5e5e5;stroke-width:1.25}

                .mono{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;fill:#050505}
                .monoMuted{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;fill:#6a6a6a}
                .h{font-size:13px;font-weight:700;letter-spacing:0.14em}
                .t{font-size:12px}
                .micro{font-size:11px;letter-spacing:0.05em}

                .arrow{stroke:#8a8a8a;stroke-width:2;fill:none}
                .arrowDash{stroke:#b8b8b8;stroke-width:1.5;fill:none;stroke-dasharray:6 6}

                .pill{fill:#ffffff;stroke:#cfcfcf;stroke-width:1.5; rx:6}
                .pillText{font-size:12px;font-weight:600;letter-spacing:0.10em}
                .okDot{fill:#00cc00}

                .stepbox-hit{fill:transparent; cursor:pointer;}

                .chip{fill:#ffffff;stroke:#cfcfcf;stroke-width:1.25}
                .chipText{font-size:12px;font-weight:700;letter-spacing:0.12em}

                .miniBtn{fill:#ffffff;stroke:#cfcfcf;stroke-width:1.25}
                .miniBtnText{font-size:11px;font-weight:700;letter-spacing:0.10em}
              </style>

              <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="#8a8a8a"/>
              </marker>

              <marker id="arrowheadOn" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="#050505"/>
              </marker>

              <marker id="arrowheadLight" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="#b8b8b8"/>
              </marker>
            </defs>

            <!-- OUTER -->
            <rect class="frame" x="70" y="50" width="1460" height="620" rx="18"/>

            <!-- Title (shorter, less dense) -->
            <text class="mono" x="120" y="108" style="font-size:22px;font-weight:700;letter-spacing:-0.01em;">
              Deterministic Record Flow (Public Skeleton)
            </text>
            <text class="monoMuted micro" x="120" y="134">POST-EXECUTION • NON-CAUSAL • NAMES & THRESHOLDS OMITTED</text>
            <text class="monoMuted micro" x="120" y="156">BUILD v5 • 2026 • PUBLIC PREVIEW</text>

            <!-- Compact note (kept, but cleaner) -->
            <text class="monoMuted micro" x="120" y="188">
              Shows the evidence-formation contract: what must exist before any module can report results.
            </text>
            <text class="monoMuted micro" x="120" y="208">
              Interactive regimes + oracle assistance exist downstream and are intentionally omitted.
            </text>

            <!-- AUDIT MODE chip (top-right) -->
            <g id="auditChip">
              <rect class="chip" x="1248" y="90" width="260" height="34" rx="10"/>
              <circle class="okDot" cx="1268" cy="107" r="5"/>
              <text class="mono chipText" x="1282" y="112">AUDIT MODE ACTIVE</text>
            </g>

            <!-- TELEMETRY line -->
            <text class="monoMuted micro" x="120" y="242">TELEMETRY: CYCLE 0215 • PHASE 01/06 • T+00:13</text>

            <!-- BOXES -->
            <g id="step1" class="dim">
              <rect id="box1" class="box" x="120" y="300" width="210" height="150" rx="12"/>
              <text class="mono h" x="142" y="340">RECORD INTAKE</text>
              <text class="monoMuted t" x="142" y="375">stored outputs</text>
              <text class="monoMuted t" x="142" y="397">transcripts</text>
              <text class="monoMuted t" x="142" y="419">immutable boundary</text>

              <g class="badge" id="badge1">
                <rect x="128" y="308" width="42" height="22" rx="6" fill="#fff" stroke="#cfcfcf" stroke-width="1.25"/>
                <text class="mono" x="142" y="323" style="font-size:12px;font-weight:700;">01</text>
              </g>
              <rect class="stepbox-hit" x="120" y="300" width="210" height="150" rx="12" data-step="0"/>
            </g>

            <g id="step2" class="dim">
              <rect id="box2" class="box" x="358" y="300" width="210" height="150" rx="12"/>
              <text class="mono h" x="380" y="340">CANONICALIZE</text>
              <text class="monoMuted t" x="380" y="375">schema normalize</text>
              <text class="monoMuted t" x="380" y="397">span indexing</text>
              <text class="monoMuted t" x="380" y="419">deterministic transforms</text>

              <g class="badge" id="badge2">
                <rect x="366" y="308" width="42" height="22" rx="6" fill="#fff" stroke="#cfcfcf" stroke-width="1.25"/>
                <text class="mono" x="380" y="323" style="font-size:12px;font-weight:700;">02</text>
              </g>
              <rect class="stepbox-hit" x="358" y="300" width="210" height="150" rx="12" data-step="1"/>
            </g>

            <g id="step3" class="dim">
              <rect id="box3" class="box" x="596" y="300" width="210" height="150" rx="12"/>
              <text class="mono h" x="618" y="340">LEXICON BIND</text>
              <text class="monoMuted t" x="618" y="375">frozen term map</text>
              <text class="monoMuted t" x="618" y="397">versioned semantics</text>
              <text class="monoMuted t" x="618" y="419">pre-measure constraint</text>

              <g class="badge" id="badge3">
                <rect x="604" y="308" width="42" height="22" rx="6" fill="#fff" stroke="#cfcfcf" stroke-width="1.25"/>
                <text class="mono" x="618" y="323" style="font-size:12px;font-weight:700;">03</text>
              </g>
              <rect class="stepbox-hit" x="596" y="300" width="210" height="150" rx="12" data-step="2"/>
            </g>

            <g id="step4" class="dim">
              <rect id="box4" class="box" x="834" y="300" width="210" height="150" rx="12"/>
              <text class="mono h" x="856" y="340">STRUCTURAL</text>
              <text class="mono h" x="856" y="360">DIAGNOSTICS</text>
              <text class="monoMuted t" x="856" y="390">invariants</text>
              <text class="monoMuted t" x="856" y="412">structure-only signals</text>

              <g class="badge" id="badge4">
                <rect x="842" y="308" width="42" height="22" rx="6" fill="#fff" stroke="#cfcfcf" stroke-width="1.25"/>
                <text class="mono" x="856" y="323" style="font-size:12px;font-weight:700;">04</text>
              </g>
              <rect class="stepbox-hit" x="834" y="300" width="210" height="150" rx="12" data-step="3"/>
            </g>

            <g id="step5" class="dim">
              <rect id="box5" class="box" x="1072" y="300" width="210" height="150" rx="12"/>
              <text class="mono h" x="1094" y="340">AUDIT PACKET</text>
              <text class="monoMuted t" x="1094" y="375">hash + provenance</text>
              <text class="monoMuted t" x="1094" y="397">links to evidence</text>
              <text class="monoMuted t" x="1094" y="419">replay references</text>

              <g class="badge" id="badge5">
                <rect x="1080" y="308" width="42" height="22" rx="6" fill="#fff" stroke="#cfcfcf" stroke-width="1.25"/>
                <text class="mono" x="1094" y="323" style="font-size:12px;font-weight:700;">05</text>
              </g>
              <rect class="stepbox-hit" x="1072" y="300" width="210" height="150" rx="12" data-step="4"/>
            </g>

            <g id="step6" class="dim">
              <rect id="box6" class="box" x="1310" y="300" width="210" height="150" rx="12"/>
              <text class="mono h" x="1332" y="340">EVIDENCE</text>
              <text class="mono h" x="1332" y="360">ARTIFACTS</text>
              <text class="monoMuted t" x="1332" y="375">screenshots</text>
              <text class="monoMuted t" x="1332" y="397">CSV / JSON export</text>
              <text class="monoMuted t" x="1332" y="419">auditable bundle</text>

              <g class="badge" id="badge6">
                <rect x="1318" y="308" width="42" height="22" rx="6" fill="#fff" stroke="#cfcfcf" stroke-width="1.25"/>
                <text class="mono" x="1332" y="323" style="font-size:12px;font-weight:700;">06</text>
              </g>
              <rect class="stepbox-hit" x="1310" y="300" width="210" height="150" rx="12" data-step="5"/>
            </g>

            <!-- ARROWS -->
            <path id="a12" class="arrow dim" marker-end="url(#arrowhead)" d="M330 385 L358 385"/>
            <path id="a23" class="arrow dim" marker-end="url(#arrowhead)" d="M568 385 L596 385"/>
            <path id="a34" class="arrow dim" marker-end="url(#arrowhead)" d="M806 385 L834 385"/>
            <path id="a45" class="arrow dim" marker-end="url(#arrowhead)" d="M1044 385 L1072 385"/>
            <path id="a56" class="arrow dim" marker-end="url(#arrowhead)" d="M1282 385 L1310 385"/>

            <!-- Canonical Lexicon side input -->
            <g id="lexSide" class="dim">
              <rect class="boxSoft" x="596" y="260" width="210" height="28" rx="8"/>
              <text class="monoMuted micro" x="612" y="279">CANONICAL LEXICON (FROZEN)</text>
              <path id="lexArrow" class="arrowDash" marker-end="url(#arrowheadLight)" d="M701 288 L701 300"/>
            </g>

            <!-- Status -->
            <rect class="frame" x="120" y="520" width="1400" height="96" rx="14" style="stroke:#ededed"/>
            <text class="monoMuted micro" x="142" y="558">STATUS:</text>

            <rect class="pill" x="230" y="540" width="230" height="44"/><circle class="okDot" cx="252" cy="562" r="5"/>
            <text class="mono pillText" x="266" y="567">DETERMINISTIC</text>

            <rect class="pill" x="475" y="540" width="230" height="44"/><circle class="okDot" cx="497" cy="562" r="5"/>
            <text class="mono pillText" x="511" y="567">LEXICON-BOUND</text>

            <rect class="pill" x="720" y="540" width="260" height="44"/><circle class="okDot" cx="742" cy="562" r="5"/>
            <text class="mono pillText" x="756" y="567">RECORD-GROUNDED</text>

            <rect class="pill" x="995" y="540" width="240" height="44"/><circle class="okDot" cx="1017" cy="562" r="5"/>
            <text class="mono pillText" x="1031" y="567">SPAN-TRACEABLE</text>

            <rect class="pill" x="1250" y="540" width="240" height="44"/><circle class="okDot" cx="1272" cy="562" r="5"/>
            <text class="mono pillText" x="1286" y="567">REPRODUCIBLE</text>

            <!-- RESULT TRAY (appears at step 6) -->
            <g id="resultTray" style="opacity:0; transition: opacity 220ms ease;">
              <rect x="120" y="630" width="1400" height="56" rx="12" fill="#fff" stroke="#ededed" stroke-width="1.25"/>
              <text class="mono" x="142" y="664" style="font-size:12px;font-weight:800;letter-spacing:0.14em;">AUDIT PACKET PREVIEW</text>

              <text class="monoMuted" x="380" y="663" style="font-size:11px;letter-spacing:0.05em;">
                record_id: <tspan class="mono" style="font-weight:700;">RD-REC-0215-0A7C</tspan> •
                hashes: <tspan class="mono" style="font-weight:700;">sha256: 9f2c…b18e</tspan>
              </text>

              <text class="monoMuted" x="900" y="663" style="font-size:11px;letter-spacing:0.05em;">
                artifacts: <tspan class="mono" style="font-weight:700;">3 screenshots</tspan> •
                <tspan class="mono" style="font-weight:700;">2 tables</tspan> •
                <tspan class="mono" style="font-weight:700;">1 json</tspan>
                • trace: <tspan class="mono" style="font-weight:700;">metric → span → source</tspan>
              </text>

              <g transform="translate(1320,642)">
                <rect class="miniBtn" x="0" y="0" width="88" height="30" rx="10"/>
                <text class="mono miniBtnText" x="18" y="20">EXPORT</text>
              </g>
              <g transform="translate(1420,642)">
                <rect class="miniBtn" x="0" y="0" width="76" height="30" rx="10"/>
                <text class="mono miniBtnText" x="22" y="20">VIEW</text>
              </g>
            </g>

            <!-- Omitted line -->
            <text class="monoMuted micro" x="120" y="706">OMITTED: interactive modules • oracle assistance • analytic regimes • live API surfaces</text>
          </svg>
        </div>
      </div>

      <div class="panel">
        <div class="kicker">guided sequence</div>

        <div class="stepnum">
          <span id="stepNum">STEP 1 / 6</span>
          <span class="smallHint">Click 1–6</span>
        </div>

        <div class="progress" id="progress"></div>

        <div class="steptitle" id="stepTitle">Record Intake</div>
        <div class="steptext" id="stepText">
          Immutable capture of model I/O, transcripts, and artifacts. Establishes a stable record boundary before any analysis.
        </div>

        <div class="controls">
          <button class="btn" id="prevBtn">Prev</button>
          <button class="btn" id="nextBtn">Next</button>
          <button class="btn" id="autoBtn">Auto</button>
          <button class="btn" id="pauseBtn">Pause</button>
          <button class="btn" id="restartBtn">Restart</button>
        </div>

        <div class="stepList" id="stepList"></div>
      </div>
    </div>
  </div>

  <script>
    const steps = [
      { id:"step1", box:"box1", badge:"badge1", arrow:null,  title:"Record Intake",
        text:"Immutable capture of model I/O, transcripts, and artifacts. Establishes a stable record boundary before any analysis." },

      { id:"step2", box:"box2", badge:"badge2", arrow:"a12", title:"Canonicalize",
        text:"Deterministic normalization and span indexing. Converts raw artifacts into a stable measurement substrate." },

      { id:"step3", box:"box3", badge:"badge3", arrow:"a23", title:"Lexicon Bind",
        text:"Binds records to a frozen, versioned term and schema specification. Constrains measurement semantics pre-computation." },

      { id:"step4", box:"box4", badge:"badge4", arrow:"a34", title:"Structural Diagnostics",
        text:"Computes structure-only signals (invariants, integrity checks) without truth, intent, or policy judgment." },

      { id:"step5", box:"box5", badge:"badge5", arrow:"a45", title:"Audit Packet",
        text:"Produces a traceable audit packet: provenance, hashes, evidence links, and replay references." },

      { id:"step6", box:"box6", badge:"badge6", arrow:"a56", title:"Evidence Artifacts",
        text:"Exports an auditable bundle (screenshots + CSV/JSON) suitable for controlled technical review." }
    ];

    let idx = 0;
    let timer = null;
    const intervalMs = 1900;

    const stepNum = document.getElementById("stepNum");
    const stepTitle = document.getElementById("stepTitle");
    const stepText = document.getElementById("stepText");
    const progress = document.getElementById("progress");
    const stepList = document.getElementById("stepList");
    const resultTray = document.getElementById("resultTray");

    // Build numbered ticks
    const ticks = steps.map((s, i) => {
      const t = document.createElement("div");
      t.className = "tick";
      t.textContent = String(i + 1);
      t.title = `Step ${i+1}: ${s.title}`;
      t.addEventListener("click", () => activate(i));
      progress.appendChild(t);
      return t;
    });

    // Build readable list (same click behavior)
    const rows = steps.map((s, i) => {
      const r = document.createElement("div");
      r.className = "stepRow";
      r.innerHTML = `
        <div class="left">
          <div class="n">${String(i+1)}</div>
          <div class="label">${s.title}</div>
        </div>
        <div class="chev">›</div>
      `;
      r.title = `Go to step ${i+1}`;
      r.addEventListener("click", () => activate(i));
      stepList.appendChild(r);
      return r;
    });

    function setClass(el, add, remove){
      if(!el) return;
      el.classList.add(add);
      el.classList.remove(remove);
    }

    function resetBoxStrokes(){
      steps.forEach(s => {
        const box = document.getElementById(s.box);
        if(!box) return;
        box.style.stroke = "#cfcfcf";
        box.style.strokeWidth = "1.5";
      });
    }

    function resetArrows(){
      ["a12","a23","a34","a45","a56"].forEach(id => {
        const a = document.getElementById(id);
        if(!a) return;
        a.style.stroke = getComputedStyle(document.documentElement).getPropertyValue("--arrowOff").trim() || "#8a8a8a";
        a.setAttribute("marker-end","url(#arrowhead)");
      });
    }

    function clearLift(){
      steps.forEach(s => {
        const g = document.getElementById(s.id);
        if(g) g.classList.remove("lift");
      });
    }

    function showResultTray(show){
      if(!resultTray) return;
      resultTray.style.opacity = show ? "1" : "0";
      const trayRect = resultTray.querySelector("rect");
      if(trayRect){
        trayRect.style.filter = show
          ? "drop-shadow(0 18px 40px rgba(0,0,0,0.10)) drop-shadow(0 0 22px rgba(0,204,0,0.10))"
          : "none";
      }
    }

    function activate(i){
      idx = (i + steps.length) % steps.length;

      // Dim all groups + hide badges
      steps.forEach(s => {
        setClass(document.getElementById(s.id), "dim", "active");
        const b = document.getElementById(s.badge);
        if(b) b.classList.remove("show");
      });

      // Dim arrows + lex side
      ["a12","a23","a34","a45","a56"].forEach(a => setClass(document.getElementById(a), "dim", "active"));
      setClass(document.getElementById("lexSide"), "dim", "active");

      resetBoxStrokes();
      resetArrows();
      clearLift();

      // Activate current
      const s = steps[idx];
      const g = document.getElementById(s.id);
      setClass(g, "active", "dim");
      g.classList.add("lift");

      const b = document.getElementById(s.badge);
      if(b) b.classList.add("show");

      // Thicken active box border (selection only)
      const box = document.getElementById(s.box);
      if(box){
        box.style.stroke = getComputedStyle(document.documentElement).getPropertyValue("--activeStroke").trim() || "#050505";
        box.style.strokeWidth = getComputedStyle(document.documentElement).getPropertyValue("--activeStrokeW").trim() || "2.5";
      }

      // Light arrow into current step (if any)
      if(s.arrow){
        const a = document.getElementById(s.arrow);
        if(a){
          setClass(a, "active", "dim");
          a.style.stroke = getComputedStyle(document.documentElement).getPropertyValue("--arrowOn").trim() || "#050505";
          a.setAttribute("marker-end","url(#arrowheadOn)");
        }
      }

      // Lexicon side only during step 3
      if(s.id === "step3"){
        setClass(document.getElementById("lexSide"), "active", "dim");
      }

      // Result tray only at step 6
      showResultTray(s.id === "step6");

      // Panel text
      stepNum.textContent = `STEP ${idx+1} / ${steps.length}`;
      stepTitle.textContent = s.title;
      stepText.textContent = s.text;

      // Ticks
      ticks.forEach((t, j) => {
        t.classList.toggle("on", j <= idx);
        t.classList.toggle("active", j === idx);
      });

      // List highlight
      rows.forEach((r, j) => r.classList.toggle("active", j === idx));
    }

    function next(){ activate(idx + 1); }
    function prev(){ activate(idx - 1); }

    function auto(){
      if(timer) return;
      timer = setInterval(next, intervalMs);
    }

    function pause(){
      if(!timer) return;
      clearInterval(timer);
      timer = null;
    }

    // Buttons
    document.getElementById("nextBtn").addEventListener("click", next);
    document.getElementById("prevBtn").addEventListener("click", prev);
    document.getElementById("autoBtn").addEventListener("click", auto);
    document.getElementById("pauseBtn").addEventListener("click", pause);
    document.getElementById("restartBtn").addEventListener("click", () => activate(0));

    // Keyboard
    document.addEventListener("keydown", (e) => {
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.key.toLowerCase() === "r") activate(0);
      if(e.key.toLowerCase() === "a") auto();
      if(e.key.toLowerCase() === "p") pause();
    });

    // Click boxes to jump
    document.querySelectorAll(".stepbox-hit").forEach(el => {
      el.addEventListener("click", (e) => {
        const n = Number(e.target.getAttribute("data-step"));
        if(Number.isFinite(n)) activate(n);
      });
    });

    // Init
    activate(0);
  </script>
</body>
</html>
